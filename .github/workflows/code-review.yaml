name: Gemini AI Code Reviewer

on:
  issue_comment:
    types: [created]
  pull_request:
    branches: [main]

permissions: write-all

jobs:
  auto-comment:
    runs-on: ubuntu-latest
    # Skip forks where your PAT likely can't write
    if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
    steps:
      - name: Post /gemini-review if not already present
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          if gh api repos/$REPO/issues/$PR_NUMBER/comments --paginate --jq '.[].body' | grep -q '^/gemini-review\b'; then
            echo "Comment already exists. Skipping."
          else
            gh api repos/$REPO/issues/$PR_NUMBER/comments -f body='/gemini-review'
            echo "Posted /gemini-review."
          fi
  gemini-code-review:
    runs-on: ubuntu-latest
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/gemini-review')
    steps:
      - name: PR Info
        run: |
          echo "You are a strict reviewer. Please review the following PR for any errors or unintended changes."
          echo "Your personality is that of an enthusiastic, highly technical, smart cowboy. Please use technical language, but supplement with cowboy sayings."
          echo "Comment: ${{ github.event.comment.body }}"
          echo "Issue Number: ${{ github.event.issue.number }}"
          echo "Repository: ${{ github.repository }}"

      - name: Checkout Repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get PR Details
        id: pr
        run: |
          PR_JSON=$(gh api repos/${{ github.repository }}/pulls/${{ github.event.issue.number }})
          echo "head_sha=$(echo $PR_JSON | jq -r .head.sha)" >> $GITHUB_OUTPUT
          echo "base_sha=$(echo $PR_JSON | jq -r .base.sha)" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - uses: truongnh1992/gemini-ai-code-reviewer@main
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: gemini-2.5-pro
          EXCLUDE: "*.md,*.txt,package-lock.json,*.yml,*.yaml"
